{% extends 'customers_app/main.html' %}
{% load static %}
{% load custom %}

{% block title %}
    <title>{{ title }}</title>
{% endblock %}

{% block custome_css %}
    <link rel="stylesheet" href="{% static 'admin_templates/vendor/select2/css/select2.css' %}"/>
    <link rel="stylesheet"
          href="{% static 'admin_templates/vendor/select2-bootstrap-theme/select2-bootstrap.min.css' %}"/>
    <link rel="stylesheet" href="{% static 'admin_templates/vendor/pnotify/pnotify.custom.css' %}"/>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

{% endblock %}

{% block custome_script %}
    <script src="{% static 'admin_templates/vendor/select2/js/select2.js' %}"></script>
    <script src="{% static 'admin_templates/vendor/pnotify/pnotify.custom.js' %}"></script>

{% endblock %}

{% block content %}

    <section role="main" class="content-body content-body-modern mt-0">

    <!-- Форма выбора года -->
    <form method="GET" action="{% url 'hrdepartment_app:management_dashboard' %}">
        <label for="year">Выберите год:</label>
        <select name="year" id="year">
            {% for year in years %}
                <option value="{{ year }}" {% if selected_year == year %}selected{% endif %}>{{ year }}</option>
            {% endfor %}
        </select>
        <button type="submit">Применить</button>
    </form>


    <!-- Экспорт данных -->
    <a href="{% url 'hrdepartment_app:export_trips' %}" class="btn btn-primary">Экспорт данных</a>
<div class="dashboard-container">
    <h1>Аналитика служебных поездок</h1>

    <!-- Основные метрики -->
    <div class="metrics-row">
        <div class="metric-card">
            <h3>Всего поездок</h3>
            <p>{{ total_trips }}</p>
        </div>
        <div class="metric-card">
            <h3>Активные поездки</h3>
            <p>{{ active_trips }}</p>
        </div>
        <div class="metric-card">
            <h3>Общие расходы</h3>
            <p>{{ total_expenses|floatformat:2 }} ₽</p>
        </div>
    </div>

    <!-- Графики -->
    <div class="charts-row">
        <div class="chart-card">
            <h3>Распределение по типам поездок</h3>
            <div class="chart-wrapper">
                <canvas id="tripTypesChart"></canvas>
            </div>
        </div>
        <div class="chart-card">
            <h3>Статусы документов</h3>
            <div class="chart-wrapper">
                <canvas id="statusChart"></canvas>
            </div>
        </div>
    </div>

    <div class="chart-card full-width">
        <h3>Динамика поездок по месяцам</h3>
        <div class="chart-wrapper">
            <canvas id="monthlyTrendsChart"></canvas>
        </div>
    </div>
</div>

<!-- Подключаем Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Общая конфигурация для всех графиков
    Chart.defaults.font.family = "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif";
    Chart.defaults.font.size = 12;
    Chart.defaults.aspectRatio = 1.5;

    // Функция для создания адаптивных графиков
    function createChart(elementId, config) {
        const ctx = document.getElementById(elementId).getContext('2d');
        return new Chart(ctx, {
            ...config,
            options: {
                ...config.options,
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                    }
                }
            }
        });
    }

    // График типов поездок
    createChart('tripTypesChart', {
        type: 'pie',
        data: {
            labels: [{% for type in trip_types %}'{{ type.get_type_trip_display }}',{% endfor %}],
            datasets: [{
                data: [{% for type in trip_types %}{{ type.count }},{% endfor %}],
                backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56']
            }]
        }
    });

    // График статусов
    createChart('statusChart', {
        type: 'doughnut',
        data: {
            labels: ['На согласовании', 'Утверждено', 'Отклонено'],
            datasets: [{
                data: [
                    {{ status_stats.awaiting_approval }},
                    {{ status_stats.approved }},
                    {{ status_stats.rejected }}
                ],
                backgroundColor: ['#FF9F40', '#4BC0C0', '#FF6384']
            }]
        }
    });

    // График трендов
    createChart('monthlyTrendsChart', {
        type: 'line',
        data: {
            labels: [{% for month in monthly_trends %}'{{ month.month|date:"M Y" }}',{% endfor %}],
            datasets: [
                {
                    label: 'Количество поездок',
                    data: [{% for month in monthly_trends %}{{ month.count }},{% endfor %}],
                    borderColor: '#36A2EB',
                    backgroundColor: 'rgba(54, 162, 235, 0.1)',
                    yAxisID: 'y',
                    tension: 0.3,
                    fill: true
                },
                {
                    label: 'Расходы (руб)',
                    data: [{% for month in monthly_trends %}{{ month.expenses|default:0 }},{% endfor %}],
                    borderColor: '#FFCE56',
                    backgroundColor: 'rgba(255, 206, 86, 0.1)',
                    yAxisID: 'y1',
                    tension: 0.3,
                    fill: true
                }
            ]
        },
        options: {
            scales: {
                y: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                    grid: {
                        drawOnChartArea: false
                    }
                },
                y1: {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    grid: {
                        drawOnChartArea: false
                    }
                },
                x: {
                    grid: {
                        display: false
                    }
                }
            }
        }
    });
</script>

<style>
    :root {
        --card-bg: #ffffff;
        --border-radius: 8px;
        --box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        --primary-color: #4a6fa5;
        --secondary-color: #666;
        --padding: 16px;
        --gap: 20px;
    }

    .dashboard-container {
        padding: var(--padding);
        max-width: 1200px;
        margin: 0 auto;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    .dashboard-container h1 {
        color: var(--primary-color);
        margin-bottom: 24px;
        font-size: 24px;
    }

    .metrics-row {
        display: flex;
        gap: var(--gap);
        margin-bottom: 30px;
        flex-wrap: wrap;
    }

    .metric-card {
        flex: 1;
        min-width: 150px;
        padding: var(--padding);
        background: var(--card-bg);
        border-radius: var(--border-radius);
        box-shadow: var(--box-shadow);
        text-align: center;
    }

    .metric-card h3 {
        margin-top: 0;
        color: var(--secondary-color);
        font-size: 14px;
        font-weight: 600;
    }

    .metric-card p {
        font-size: 24px;
        font-weight: bold;
        margin: 10px 0 0;
        color: var(--primary-color);
    }

    .charts-row {
        display: flex;
        gap: var(--gap);
        margin-bottom: 30px;
        flex-wrap: wrap;
    }

    .chart-card {
        flex: 1;
        min-width: 300px;
        background: var(--card-bg);
        border-radius: var(--border-radius);
        box-shadow: var(--box-shadow);
        padding: var(--padding);
    }

    .chart-card.full-width {
        flex: 100%;
    }

    .chart-card h3 {
        margin-top: 0;
        margin-bottom: 16px;
        color: var(--primary-color);
        font-size: 16px;
    }

    .chart-wrapper {
        position: relative;
        width: 100%;
        min-height: 300px;
    }

    @media (max-width: 768px) {
        .metrics-row, .charts-row {
            flex-direction: column;
        }

        .metric-card, .chart-card {
            min-width: 100%;
        }
    }
</style>
    </section>
{% endblock %}