{% extends 'customers_app/main.html' %}
{% load static %}
{% load custom %}

{% block title %}
    <title>{{ title }}</title>
{% endblock %}

{% block custome_css %}
    <link rel="stylesheet" href="{% static 'admin_templates/vendor/select2/css/select2.css' %}"/>
    <link rel="stylesheet"
          href="{% static 'admin_templates/vendor/select2-bootstrap-theme/select2-bootstrap.min.css' %}"/>
    <link rel="stylesheet" href="{% static 'admin_templates/vendor/pnotify/pnotify.custom.css' %}"/>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

{% endblock %}

{% block custome_script %}
    <script src="{% static 'admin_templates/vendor/select2/js/select2.js' %}"></script>
    <script src="{% static 'admin_templates/vendor/pnotify/pnotify.custom.js' %}"></script>

{% endblock %}

{% block content %}

    <section role="main" class="content-body content-body-modern mt-0">
            <h1>Распределение типов времени</h1>

    <!-- Форма выбора года -->
    <form method="GET" action="{% url 'hrdepartment_app:time_distribution' %}">
        <label for="year">Выберите год:</label>
        <select name="year" id="year">
            {% for year in years %}
                <option value="{{ year }}" {% if selected_year == year %}selected{% endif %}>{{ year }}</option>
            {% endfor %}
        </select>
        <button type="submit">Применить</button>
    </form>

    <div class="dashboard-container">
    <h1>Аналитика служебных поездок</h1>

    <!-- Основные метрики -->
    <div class="metrics-row">
        <div class="metric-card">
            <h3>Всего поездок</h3>
            <p>{{ total_trips }}</p>
        </div>
        <div class="metric-card">
            <h3>Активные поездки</h3>
            <p>{{ active_trips }}</p>
        </div>
        <div class="metric-card">
            <h3>Общие расходы</h3>
            <p>{{ total_expenses|floatformat:2 }} ₽</p>
        </div>
    </div>

    <!-- Графики -->
    <div class="charts-row">
        <div class="chart-container">
            <h3>Распределение по типам поездок</h3>
            <canvas id="tripTypesChart"></canvas>
        </div>
        <div class="chart-container">
            <h3>Статусы документов</h3>
            <canvas id="statusChart"></canvas>
        </div>
    </div>

    <div class="full-width-chart">
        <h3>Динамика поездок по месяцам</h3>
        <canvas id="monthlyTrendsChart"></canvas>
    </div>
</div>
    <!-- Экспорт данных -->
    <a href="{% url 'hrdepartment_app:export_trips' %}" class="btn btn-primary">Экспорт данных</a>
{#    <a href="{% url 'hrdepartment_app:export_trips' %}?year={{ selected_year }}" class="btn btn-primary">Экспорт данных</a>#}
{#    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>#}
<script>
    // График типов поездок
    const tripTypesCtx = document.getElementById('tripTypesChart').getContext('2d');
    new Chart(tripTypesCtx, {
        type: 'pie',
        data: {
            labels: [{% for type in trip_types %}'{{ type.type_trip }}',{% endfor %}],
            datasets: [{
                data: [{% for type in trip_types %}{{ type.count }},{% endfor %}],
                backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56']
            }]
        }
    });

    // График статусов
    const statusCtx = document.getElementById('statusChart').getContext('2d');
    new Chart(statusCtx, {
        type: 'doughnut',
        data: {
            labels: ['На согласовании', 'Утверждено', 'Отклонено'],
            datasets: [{
                data: [
                    {{ status_stats.awaiting_approval }},
                    {{ status_stats.approved }},
                    {{ status_stats.rejected }}
                ],
                backgroundColor: ['#FF9F40', '#4BC0C0', '#FF6384']
            }]
        }
    });

    // График трендов
    const trendsCtx = document.getElementById('monthlyTrendsChart').getContext('2d');
    new Chart(trendsCtx, {
        type: 'line',
        data: {
            labels: [{% for month in monthly_trends %}'{{ month.month|date:"M Y" }}',{% endfor %}],
            datasets: [
                {
                    label: 'Количество поездок',
                    data: [{% for month in monthly_trends %}{{ month.count }},{% endfor %}],
                    borderColor: '#36A2EB',
                    yAxisID: 'y'
                },
                {
                    label: 'Расходы (руб)',
                    data: [{% for month in monthly_trends %}{{ month.expenses|default:0 }},{% endfor %}],
                    borderColor: '#FFCE56',
                    yAxisID: 'y1'
                }
            ]
        },
        options: {
            scales: {
                y: {
                    type: 'linear',
                    display: true,
                    position: 'left'
                },
                y1: {
                    type: 'linear',
                    display: true,
                    position: 'right'
                }
            }
        }
    });
</script>
    <style>
    .dashboard-container {
        padding: 20px;
        max-width: 1200px;
        margin: 0 auto;
    }
    .metrics-row {
        display: flex;
        gap: 20px;
        margin-bottom: 30px;
    }
    .metric-card {
        flex: 1;
        padding: 20px;
        background: #f5f5f5;
        border-radius: 8px;
        text-align: center;
    }
    .metric-card h3 {
        margin-top: 0;
        color: #555;
    }
    .metric-card p {
        font-size: 24px;
        font-weight: bold;
        margin: 10px 0 0;
    }
    .charts-row {
        display: flex;
        gap: 20px;
        margin-bottom: 30px;
    }
    .chart-container {
        flex: 1;
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .full-width-chart {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
</style>
    </section>
{% endblock %}