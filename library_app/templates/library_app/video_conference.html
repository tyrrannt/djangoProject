{% extends 'customers_app/main.html' %}
{% load static %}
{% load custom %}
{% load widget_tweaks %}

{% block title %}
    <title>{{ title }}</title>
    <style>
        #videos {
            display: flex;
            flex-wrap: wrap;
        }
        video {
            width: 300px;
            height: 200px;
            margin: 10px;
        }
    </style>
{% endblock %}

{% block content %}
    <style>
        .text-big {
            font-size: 16px;
        }
    </style>
    <section role="main" class="content-body content-body-modern mt-0">
        {% include 'library_app/breadcrumb.html' %}
        <div>
            {% if form.errors %}
                {% for field in form %}
                    {% for error in field.errors %}
                        <div class="alert alert-danger">
                            <strong>{{ field.label }}</strong>: {{ error|escape }}
                        </div>
                    {% endfor %}
                {% endfor %}
                {% for error in form.non_field_errors %}
                    <div class="alert alert-danger">
                        <strong>{{ field.label }}</strong>: {{ error|escape }}
                    </div>
                {% endfor %}
            {% endif %}
        </div>
        <!-- start: page -->
        <div id="videos">
        <video id="localVideo" autoplay muted></video>
    </div>

    <script src="{% static 'admin_templates/vendor/simplewebrtc/simplewebrtc.bundle.min.js' %}"></script>
    <script>
        const localVideo = document.getElementById('localVideo');
        const videosContainer = document.getElementById('videos');

        const webrtc = new SimpleWebRTC({
            localVideoEl: 'localVideo',
            remoteVideosEl: '',
            autoRequestMedia: true,
        });

        webrtc.on('readyToCall', () => {
            webrtc.joinRoom('video_conference');
        });

        webrtc.on('videoAdded', (video, peer) => {
            const videoElement = document.createElement('video');
            videoElement.srcObject = video.stream;
            videoElement.autoplay = true;
            videoElement.muted = (peer && peer.local) ? true : false;
            videoElement.id = 'video_' + webrtc.getDomId(peer);
            videosContainer.appendChild(videoElement);
        });

        webrtc.on('videoRemoved', (video, peer) => {
            const videoElement = document.getElementById('video_' + webrtc.getDomId(peer));
            if (videoElement) {
                videosContainer.removeChild(videoElement);
            }
        });

        const socket = new WebSocket('wss://' + window.location.host + '/ws/video_conference/');

        socket.onmessage = function(event) {
            const data = JSON.parse(event.data);
            console.log('Message from server:', data.message);
        };

        socket.onopen = function() {
            console.log('WebSocket connected');
        };

        socket.onclose = function() {
            console.log('WebSocket disconnected');
        };
    </script>
        <!-- end: page -->
    </section>
    <!-- end: page -->

{% endblock %}