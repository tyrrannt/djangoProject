{% extends 'customers_app/main.html' %}

{% load static %}
{% block custome_css %}

    <link rel="stylesheet" href="{% static 'admin_templates/vendor/select2/css/select2.css' %}"/>
    <link rel="stylesheet"
          href="{% static 'admin_templates/vendor/select2-bootstrap-theme/select2-bootstrap.min.css' %}"/>
    <link rel="stylesheet"
          href="{% static 'admin_templates/vendor/bootstrap-multiselect/css/bootstrap-multiselect.css' %}"/>
    <link rel="stylesheet" href="{% static 'admin_templates/vendor/bootstrap-tagsinput/bootstrap-tagsinput.css' %}"/>
{% endblock %}

{% block custome_script %}
    <script src="{% static 'admin_templates/vendor/bootstrap-tagsinput/bootstrap-tagsinput.js' %}"></script>
    <script src="{% static 'admin_templates/vendor/select2/js/select2.js' %}"></script>
    <script src="{% static 'admin_templates/vendor/bootstrapv5-multiselect/js/bootstrap-multiselect.js' %}"></script>
    <script src="{% static 'admin_templates/vendor/jquery-validation/jquery.validate.js' %}"></script>
    <script src="{% static 'admin_templates/vendor/pnotify/pnotify.custom.js' %}"></script>

    <script>
document.addEventListener('DOMContentLoaded', function () {
    const fileInput = document.getElementById('id_doc_file');
    const typeSelect = document.getElementById('id_type_of_document');

    // Все ключевые слова — в нижнем регистре!
    const mappings = [
        // Акт
        { keywords: ['акт'], value: '9' },
        // Банковская гарантия
        { keywords: ['бг', 'банкгар', 'банковская гарантия'], value: '30' },
        // Уведомление
        { keywords: ['уведомление', 'увед'], value: '19' },
        // Ведомость
        { keywords: ['ведомость', 'вед'], value: '8' },
        // Визы
        { keywords: ['визы', 'виза'], value: '42' },
        // Выписка
        { keywords: ['выписка', 'вып'], value: '38' },
        // Гарантийный талон
        { keywords: ['гартал', 'гарантийный талон'], value: '39' },
        // График
        { keywords: ['график'], value: '26' },
        // Доверенность
        { keywords: ['доверенность', 'довер'], value: '15' },
        // Договор залога
        { keywords: ['догзал', 'договор залога'], value: '6' },
        // Договор ипотеки
        { keywords: ['ипотека', 'догипот', 'договор ипотеки'], value: '52' },
        // Договор купли-продажи
        { keywords: ['дкп', 'купляпродажа', 'договор купли продажи', 'договор купли-продажи'], value: '11' },
        // Договор поручительства
        { keywords: ['поруч', 'догпор', 'договор поручительства'], value: '7' },
        // Дополнение
        { keywords: ['дополнение'], value: '46' },
        // Дополнительное соглашение
        { keywords: ['дс', 'допс', 'допсогл', 'дополнительное соглашение', 'доп соглашение'], value: '2' },
        // Задание на полёт
        { keywords: ['задание на полёт', 'знп', 'заданиенаполёт'], value: '45' },
        // Заявка
        { keywords: ['заявка'], value: '24' },
        // Заявление
        { keywords: ['заявление'], value: '29' },
        // Изменение
        { keywords: ['изменение', 'изм'], value: '51' },
        // Карта клиента
        { keywords: ['карта клиента', 'картаклиента'], value: '43' },
        // Коммерческое предложение
        { keywords: ['кп', 'компредл', 'коммерческое предложение'], value: '31' },
        // Комплект документов
        { keywords: ['комплект', 'комплдок'], value: '13' },
        // Лицензия
        { keywords: ['лицензия', 'лиц'], value: '3' },
        // Меморандум
        { keywords: ['меморандум', 'мем'], value: '28' },
        // Отчет
        { keywords: ['отчет', 'отч'], value: '22' },
        // Письмо
        { keywords: ['письмо'], value: '25' },
        // Платежное поручение
        { keywords: ['пп', 'платпор', 'платежное поручение'], value: '4' },
        // Полис
        { keywords: ['полис'], value: '36' },
        // Поручение принципиала
        { keywords: ['поручение принципиала', 'поручпринц'], value: '23' },
        // Постановление
        { keywords: ['постановление', 'пост'], value: '33' },
        // Прейскурант
        { keywords: ['прей', 'цены', 'расценки', 'прейскурант'], value: '21' },
        // Приложение
        { keywords: ['прил', 'приложение'], value: '10' },
        // Программа
        { keywords: ['программа', 'прог'], value: '5' },
        // Проект
        { keywords: ['проект'], value: '34' },
        // Протокол
        { keywords: ['протокол', 'прот'], value: '20' },
        // Расписка
        { keywords: ['расписка'], value: '50' },
        // Расчет
        { keywords: ['расчет', 'расч'], value: '35' },
        // Регламент
        { keywords: ['регламент'], value: '47' },
        // Реестр
        { keywords: ['реестр'], value: '32' },
        // Санитарно-эпидемиологическое заключение
        { keywords: ['сэз', 'санэпид', 'санитарно-эпидемиологическое заключение'], value: '44' },
        // Свидетельство
        { keywords: ['свидетельство', 'свид'], value: '14' },
        // Сертификат
        { keywords: ['сертификат', 'серт'], value: '37' },
        // Соглашение
        { keywords: ['согл', 'сог', 'соглашение'], value: '12' },
        // Соглашение о намерениях
        { keywords: ['соглнамер', 'соглашение о намерениях'], value: '49' },
        // Спецификация
        { keywords: ['спецификация', 'спец', 'специф'], value: '17' },
        // Справка
        { keywords: ['справка', 'спр'], value: '27' },
        // Счет
        { keywords: ['счет'], value: '40' },
        // Тариф
        { keywords: ['тариф'], value: '48' },
        // Форма
        { keywords: ['форма'], value: '18' },
        // Электронный документооборот
        { keywords: ['эдо', 'электронный документооборот'], value: '16' },
        // Договор
        { keywords: ['договор', 'дог'], value: '1' },
    ];

    const fallbackValue = '1'; // Скан-копия документа

    fileInput.addEventListener('change', function () {
        const file = this.files[0];
        if (!file) {
            // Можно оставить пустым или поставить fallback — по ТЗ: если не определён → скан-копия
            typeSelect.value = fallbackValue;
            // Обновляем Select2
            if (window.jQuery && jQuery.fn.select2) {
                $(typeSelect).trigger('change');
            }
            return;
        }

        // Извлекаем имя без расширения
        let fileName = file.name;
        if (fileName.lastIndexOf('.') > 0) {
            fileName = fileName.substring(0, fileName.lastIndexOf('.'));
        }

        // Приводим к нижнему регистру и убираем лишние пробелы
        const normalizedFileName = fileName.trim().toLowerCase();

        // Поиск совпадения
        let found = false;
        for (const mapping of mappings) {
            for (const keyword of mapping.keywords) {
                if (normalizedFileName.includes(keyword)) {
                    typeSelect.value = mapping.value;
                    found = true;
                    break;
                }
            }
            if (found) break;
        }

        // Если не найдено — fallback
        if (!found) {
            typeSelect.value = fallbackValue;
        }

        // Обновляем Select2, если используется
        if (window.jQuery && jQuery.fn.select2) {
            $(typeSelect).trigger('change');
        }
    });
});
</script>
{% endblock %}

{% block title %}
    <title>{{ title }}</title>
{% endblock %}


{% block content %}
    <section role="main" class="content-body content-body-modern mt-0">
        <div>
            {% if form.errors %}
                {% for field in form %}
                    {% for error in field.errors %}
                        <div class="alert alert-danger">
                            <strong>{{ field.label }}</strong>: {{ error|escape }}
                        </div>
                    {% endfor %}
                {% endfor %}
                {% for error in form.non_field_errors %}
                    <div class="alert alert-danger">
                        <strong>{{ field.label }}</strong>: {{ error|escape }}
                    </div>
                {% endfor %}
            {% endif %}
        </div>
        {#        {% include 'library_app/breadcrumb.html' %}#}
        <div><p></p></div>
        <!-- start: page -->
        <form action="{% url 'contracts_app:create' %}" method="post" enctype="multipart/form-data">
            {% csrf_token %}
            <div class="col-md-12">
                <div class="toggle toggle-primary toggle-lg" data-plugin-toggle>
                    <section class="toggle active">
                        <label>Основное</label>
                        <div class="toggle-content">
                            <div class="form-row">
                                <div class="form-group col mb-3">
                                    <div class="row text">
                                        <input class="form-control form-control-modern" id="id_parent_category"
                                               name="parent_category" type="text" value="{{ parent }}" hidden="hidden">
                                        {#                                        <div class="col-md-6 text-black-50">#}
                                        {#                                            <label for="id_parent_category" hidden="hidden">Основной документ</label>#}
                                        {#                                            <select class="form-control form-control-modern" name="parent_category_text"#}
                                        {#                                                    id="id_parent_category_text" data-plugin-selectTwo>#}
                                        {#                                                    <option selected value="{{ parent }}">{{ parent }}</option>#}
                                        {#                                            </select>#}
                                        {#                                            {{ form.parent_category }}#}
                                        {#                                            <input class="form-control form-control-modern" id="id_parent_category" name="parent_category" type="text" value="{{ parent }}" hidden="hidden">#}
                                        {#                                        </div>#}
                                        <div class="col-md-6 text-black-50">
                                            <label for="id_contract_counteragent">Контрагент</label>
                                            {{ form.contract_counteragent }}
                                        </div>
                                        <div class="col-md-6 text-black-50">
                                            <label for="id_employee">Ответственные лица</label>
                                            {{ form.employee }}
                                        </div>

                                        <div class="row text">
                                            <div class="col-md-6 text-black-50">
                                                <label for="id_type_of_document">Тип документа</label>
                                                {{ form.type_of_document }}
                                            </div>
                                            <div class="col-md-6 text-black-50">
                                                <label for="id_type_of_contract">Тип договора</label>
                                                {{ form.type_of_contract }}
                                            </div>

                                        </div>
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group col mb-3">
                                        <div class="row">
                                            <div class="col-md-4 text">
                                                <label for="id_contract_number">Номер договора</label>
                                                {{ form.contract_number }}
                                            </div>
                                            <div class="col-md-4 date">
                                                <label for="id_date_conclusion">Дата заключения</label>
                                                {{ form.date_conclusion }}
                                            </div>
                                            <div class="col-md-4 date">
                                                <label for="id_closing_date">Дата закрытия договора</label>
                                                {{ form.closing_date }}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <code>{{ object.access }}</code>
                            </div>
                            <div class="form-row">
                                <div class="form-group col mb-3">
                                    <div class="row">
                                        <div class="col-md-6 text-black-50">
                                            <label for="id_divisions">Подразделение</label>
                                            {{ form.divisions }}
                                        </div>
                                        <div class="col-md-6 text-black-50">
                                            <label for="id_type_property">Тип имущества</label>
                                            {{ form.type_property }}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group col mb-3">
                                    <div class="row">
                                        <div class="col-sm-12 col-md-6 text-black-50">
                                            <label for="id_subject_contract">Предмет договора</label>
                                            {{ form.subject_contract }}
                                        </div>
                                        <div class="col-sm-12 col-md-6 text-black-50">
                                            <label for="id_comment">Примечание:</label>
                                            {{ form.comment }}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group col mb-3">
                                    <div class="row">
                                        <div class="form-group row align-items-center">
                                            <div class="col-sm-12 col-md-5 text-black-50">
                                                <label for="id_doc_file">Файл документа:</label>
                                                {{ form.doc_file }}
                                            </div>
                                            <div class="col-sm-12 col-md-5 text-black-50">
                                                <label for="id_executor">Исполнитель:</label>
                                                {{ form.executor }}
                                            </div>
                                            <div class="col-sm-12 col-md-2 text-black-50">
                                                <label for="id_comment">Разрешение на публикацию:</label>
                                                {{ form.allowed_placed }}
                                            </div>
                                        </div>
                                    </div>
                                    <div class="form-group col mb-3">
                                        <div class="row">
                                            <div class="col-md-4 text-black-50">
                                                <label for="id_cost">Стоимость</label>
                                                {{ form.cost }}
                                            </div>
                                            <div class="col-md-4 text-black-50">
                                                <label for="id_prolongation">Пролонгация</label>
                                                {{ form.prolongation }}
                                            </div>
                                            <div class="col-md-4 text-black-50">
                                                <label for="id_access">Уровень доступа к документу:</label>
                                                {{ form.access }}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                    </section>
                </div>
            </div>
            <div class="row action-buttons">
                <div class="col-12 col-md-auto">
                    <button type="submit"
                            class="btn btn-outline-success btn-px-4 py-3 d-flex
                           align-items-center font-weight-semibold line-height-1"
                            data-loading-text="Loading...">
                        <i class="bx bx-save text-4 me-2"></i> Сохранить
                    </button>
                </div>
                <div class="col-12 col-md-auto px-md-0 mt-3 mt-md-0">
                    <a href="{% url 'contracts_app:index' %}"
                       class="btn btn-outline-dark btn-px-4 py-3 d-flex
                           align-items-center font-weight-semibold line-height-1">
                        <i class='bx bx-log-out-circle text-4 me-2'></i> Закрыть </a>
                </div>
                <div class="col-12 col-md-auto ms-md-auto mt-3 mt-md-0 ms-auto">
                    <a href="#"
                       class="btn btn-outline-danger btn-px-4 py-3 d-flex
                           align-items-center font-weight-semibold line-height-1">
                        <i class="bx bx-trash text-4 me-2"></i> Удалить
                    </a>
                </div>
            </div>
        </form>
        <!-- end: page -->
    </section>

{% endblock %}



